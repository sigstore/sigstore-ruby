#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"
require "rake"
require "net/http"
require "json"

include FileUtils # rubocop:disable Style/MixinUsage

raise(StandardError, "Usage: #{$PROGRAM_NAME} <dists...>") if ARGV.empty?

dists = ARGV
mkdir_p %w[smoketest-gem-home smoketest-artifacts]

at_exit { rm_rf "smoketest-gem-home" }

env = {
  "PATH" => "smoketest-gem-home/bin:#{ENV.fetch("PATH")}",
  "GEM_HOME" => "smoketest-gem-home",
  "GEM_PATH" => "smoketest-gem-home",
  "BUNDLE_GEMFILE" => "smoketest-gem-home/Gemfile"
}

# Get cert identity from environment
cert_identity = ENV.fetch("SIGSTORE_CERT_IDENTITY")

# Read OIDC token from file if available
oidc_token_file = ENV.fetch("OIDC_TOKEN_FILE", nil)
oidc_token = (File.read(oidc_token_file).strip if oidc_token_file && File.exist?(oidc_token_file))

sh(env, "gem", "install", *dists, "--no-document", exception: true)

File.write("smoketest-gem-home/Gemfile", <<~RUBY)
  gem "sigstore-cli"
RUBY

dists.each do |dist|
  # Build sign command with optional identity token
  sign_cmd = [
    File.expand_path("sigstore-cli", __dir__),
    "sign",
    dist
  ]

  sign_cmd.push("--identity-token", oidc_token) if oidc_token

  sign_cmd.push(
    "--signature=smoketest-artifacts/#{File.basename(dist)}.sig",
    "--certificate=smoketest-artifacts/#{File.basename(dist)}.crt",
    "--bundle=smoketest-artifacts/#{File.basename(dist)}.sigstore.json"
  )

  sh(env, *sign_cmd, exception: true)

  sh(env, File.expand_path("sigstore-cli", __dir__),
     "verify",
     "--signature=smoketest-artifacts/#{File.basename(dist)}.sig",
     "--certificate=smoketest-artifacts/#{File.basename(dist)}.crt",
     "--certificate-oidc-issuer=https://token.actions.githubusercontent.com",
     "--certificate-identity=#{cert_identity}",
     dist,
     exception: true)
  sh(env, File.expand_path("sigstore-cli", __dir__),
     "verify",
     "--bundle=smoketest-artifacts/#{File.basename(dist)}.sigstore.json",
     "--certificate-oidc-issuer=https://token.actions.githubusercontent.com",
     "--certificate-identity=#{cert_identity}",
     dist,
     exception: true)
end
